# 主从搭建

-----

### 基于：Row+Gtid的复制

- 参数设置
```
binlog_format                       =row
log_bin                             =/data/mysql/mysql3306/logs/mysql-bin                       
	
gtid_mode                           =on 
enforce_gtid_consistency            =on 

server_id                           =123306建议IP最后一位+端口号
```
- 账户和权限设置
```
create user 'repl'@'172.18.0.0/255.255.255.0' identified by 'xxx';
grant replication slave on *.* to 'repl'@'172.18.0.0/255.255.255.0'; 
```
- 执行操作
	- 备份数据库  
	```
	mysqldump -hxxx  -uxxx -pxxx -A --single-transaction --master-data=2|gzip > all.sql.gz
	```

	- 恢复到从库上  
	`mysql -hxxx -uxxx -pxxx < all.sql`
	
```
change master to 
master_host='172.18.0.11',
master_port=3306,
master_user='repl',
master_password='xxxxxx',
master_auto_position=1;

```
### 复制的种类
![](images/复制原理1.jpg)


### 复制的线程

- io_thread  
	- 异步复制
	- 半同步复制
	- 增强半同步复制
- sql_thread  
	- 5.6基于database级别的并行
	- 5.7基于binlog group commit(基于事务级别的并行)
	- 8.0基于writeset(行级别)
![](images/复制原理2.jpg)

### 日志分类

![](images/复制原理3.jpg)